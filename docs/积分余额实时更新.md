积分余额实时更新 Roadmap（WebSocket/SSE + 轮询降级）
本 Roadmap 适用于 AI 视频平台等需要积分余额实时刷新的场景，目标是让前端用户在积分变动时能第一时间看到最新余额，兼顾低延迟和高兼容性。方案采用“WebSocket 优先，SSE 备选，轮询兜底”的多级降级机制[#][#][#]。

1. 方案架构概览
WebSocket：首选，支持双向实时通信，延迟最低[#][#]。

SSE（Server-Sent Events）：WebSocket 不可用时自动降级，服务端单向推送，兼容性好[#][#]。

轮询（Polling）：前两者都不可用时，前端定时请求余额接口，保证所有用户都能看到最新数据[#][#]。

2. 阶段划分与实施步骤
阶段一：后端推送与轮询接口开发
实现 WebSocket 服务端，支持用户登录后建立连接，积分变动时主动推送最新余额[#][#]。

实现 SSE 服务端，设置 Content-Type: text/event-stream，积分变动时推送数据[#][#]。

提供 /api/credits/balance RESTful API，返回当前用户积分余额，供轮询使用[#][#]。

所有接口需鉴权，防止越权访问[#][#]。

阶段二：前端多级连接逻辑实现
页面加载时，优先尝试建立 WebSocket 连接，监听 onmessage 事件更新积分余额[#][#]。

WebSocket 连接失败时，自动切换为 SSE，监听 onmessage 事件刷新余额[#][#]。

SSE 也不可用时，自动启动 5~10 秒一次的定时轮询，调用 /api/credits/balance 接口获取余额[#][#]。

断线重连：WebSocket/SSE 断开后自动重试，连接恢复后切回推送模式[#][#]。

前端全局缓存 balance，只有变化时才刷新页面，减少无效渲染[#][#]。

阶段三：后端推送触发点与事件发布
每次积分增减（如支付回调、视频生成、后台调整）后，调用推送接口，向对应用户推送最新余额[#][#]。

多实例部署时，建议用 Redis Pub/Sub、消息队列等保证推送一致性[#][#]。

阶段四：测试与优化
本地和线上环境分别测试三种模式（WebSocket、SSE、轮询），确保切换无缝[#][#]。

模拟断网、服务器重启等异常场景，验证重连与降级逻辑[#][#]。

监控推送与轮询接口的延迟和错误率，及时报警[#][#]。

优化前端状态管理，避免重复渲染和无效请求[#][#]。

4. 交付与测试建议
提供三种模式的接口文档（WebSocket、SSE、轮询），标明 URL、参数、返回结构[#][#]。

前后端协作测试，确保积分变动后 1~2 秒内前端能看到最新余额[#][#]。

保存测试用例，便于后续自动化回归[#][#]。

5. 备注与扩展
用户量大时，需关注 WebSocket/SSE 连接数和服务器资源，必要时做限流和分布式扩展[#][#]。

后续可扩展为更多实时推送场景，如订单状态、消息通知等[#][#]。