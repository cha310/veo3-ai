# 积分余额实时更新系统实现文档

## 1. 系统架构

本系统采用多级降级机制，确保在各种网络环境下都能实现积分余额的实时更新：

1. **WebSocket**：首选方案，支持双向实时通信，延迟最低
2. **SSE（Server-Sent Events）**：WebSocket不可用时的备选方案，服务端单向推送，兼容性好
3. **轮询（Polling）**：前两者都不可用时的兜底方案，前端定时请求余额接口

在多实例部署环境下，使用Redis Pub/Sub机制保证推送一致性。

## 2. 后端实现

### 2.1 WebSocket服务

文件：`server/websocket.js`

功能：
- 提供WebSocket服务器，支持用户通过JWT令牌认证
- 维护用户连接映射，支持一个用户多个连接
- 在积分变动时向用户推送最新余额
- 集成Redis Pub/Sub，支持多实例部署

关键方法：
- `initWebSocketServer(server)`: 初始化WebSocket服务器
- `sendUserBalance(userId)`: 向指定用户发送积分余额更新
- `publishCreditChange(userId, amount, type, metadata)`: 发布积分变动事件

### 2.2 SSE服务

文件：`server/routes/credits.js`

功能：
- 提供SSE端点，支持用户通过JWT令牌认证
- 维护SSE客户端连接映射
- 在积分变动时向用户推送最新余额
- 集成Redis Pub/Sub，支持多实例部署

关键方法：
- `router.get('/sse', authenticateToken, ...)`: SSE端点
- `sendUserBalanceSSE(userId)`: 向指定用户发送SSE积分余额更新
- `notifyBalanceUpdate(userId, amount, type, metadata)`: 通知积分余额更新（WebSocket + SSE）

### 2.3 轮询接口

文件：`server/routes/credits.js`

功能：
- 提供REST API端点，用于前端轮询获取最新积分余额
- 返回建议的轮询间隔，优化前端轮询策略

端点：
- `GET /api/credits/balance/poll`: 轮询接口，返回最新积分余额和建议轮询间隔

### 2.4 Redis Pub/Sub服务

文件：`server/redis-pubsub.js`

功能：
- 提供Redis Pub/Sub服务，用于在多实例部署时同步积分变动事件
- 支持发布和订阅积分变动事件
- 提供优雅的连接管理和错误处理

关键方法：
- `initRedisClients()`: 初始化Redis客户端
- `publishCreditChange(userId, amount, type, metadata)`: 发布积分变动事件
- `onCreditChange(handler)`: 注册积分变动事件处理器

### 2.5 认证中间件

文件：`server/middleware/auth.js`

功能：
- 提供JWT令牌验证中间件
- 支持直接使用JWT密钥验证或回退到Supabase验证

关键方法：
- `authenticateToken(req, res, next)`: 验证JWT令牌中间件

## 3. 前端实现

### 3.1 CreditContext

文件：`src/contexts/CreditContext.tsx`

功能：
- 提供全局积分余额状态管理
- 实现多级连接逻辑：WebSocket -> SSE -> 轮询
- 处理断线重连和状态恢复

关键方法：
- `connectWebSocket()`: 尝试建立WebSocket连接
- `connectSSE()`: 尝试建立SSE连接
- `startPolling()`: 启动轮询
- `handleBalanceUpdate(data)`: 处理积分余额更新

### 3.2 CreditProvider

文件：`src/App.tsx`

功能：
- 在应用根组件中提供CreditContext
- 确保所有子组件都能访问积分余额状态

### 3.3 积分余额显示

文件：`src/components/Navbar.tsx`

功能：
- 在导航栏中显示用户当前积分余额
- 实时更新积分余额

### 3.4 调试功能

文件：`src/pages/debug.tsx`

功能：
- 提供调试界面，显示连接状态和积分明细
- 支持手动触发连接和断开

## 4. 测试工具

### 4.1 WebSocket测试

文件：`server/test-websocket.js`

功能：
- 测试WebSocket连接和积分余额实时推送

### 4.2 SSE测试

文件：`server/test-sse.js`

功能：
- 测试SSE连接和积分余额实时推送

### 4.3 轮询测试

文件：`server/test-polling.js`

功能：
- 测试积分余额轮询接口

### 4.4 模拟积分变动

文件：`server/simulate-credit-change.js`

功能：
- 模拟积分变动，用于测试实时推送功能
- 支持指定用户ID、变动数量和变动类型

## 5. 使用说明

### 5.1 启动服务器

```bash
cd server
npm install
node index.js
```

### 5.2 测试WebSocket

```bash
node test-websocket.js <token>
```

### 5.3 测试SSE

```bash
node test-sse.js <token>
```

### 5.4 测试轮询

```bash
node test-polling.js <token>
```

### 5.5 模拟积分变动

```bash
node simulate-credit-change.js <user_id> <amount> <type>
```

## 6. 注意事项

1. 需要配置环境变量：
   - `SUPABASE_URL`: Supabase URL
   - `SUPABASE_SERVICE_ROLE_KEY`: Supabase服务角色密钥
   - `JWT_SECRET` 或 `SUPABASE_JWT_SECRET`: JWT密钥
   - `REDIS_URL`: Redis服务器URL（可选，默认为localhost:6379）
   - `REDIS_PASSWORD`: Redis密码（可选）

2. 多实例部署时，需要确保Redis服务可用，以保证推送一致性

3. 前端需要处理断线重连和降级逻辑，确保在各种网络环境下都能获取最新积分余额 